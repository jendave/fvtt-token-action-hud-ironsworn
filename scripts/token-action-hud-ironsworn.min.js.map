{"version":3,"file":"token-action-hud-ironsworn.min.js","sources":["constants.js","utils.js","action-handler.js","defaults.js","roll-handler.js","settings.js","system-manager.js","init.js"],"sourcesContent":["/**\n * Module-based constants\n */\nexport const MODULE = {\n    ID: 'token-action-hud-ironsworn'\n}\n\n/**\n * Core module\n */\nexport const CORE_MODULE = {\n    ID: 'token-action-hud-core'\n}\n\n/**\n * Core module version required by the system module\n */\nexport const REQUIRED_CORE_MODULE_VERSION = '1.5'\n\n/**\n * Action types\n */\nexport const ACTION_TYPE = {\n    move: 'tokenActionHud.ironsworn.moves'\n}\n\n/**\n * Groups\n */\nexport const GROUP = {\n    moves: { id: 'moves', name: 'tokenActionHud.ironsworn.moves', type: 'system' }\n}\n\n/**\n * Item types\n */\nexport const ITEM_TYPE = {\n    armor: { groupId: 'armor' },\n    backpack: { groupId: 'containers' },\n    consumable: { groupId: 'consumables' },\n    equipment: { groupId: 'equipment' },\n    treasure: { groupId: 'treasure' },\n    weapon: { groupId: 'weapons' }\n}\n","import { MODULE } from './constants.js'\n\nexport let Utils = null\n\nHooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\n    /**\n     * Utility functions\n     */\n    Utils = class Utils {\n        /**\n         * Get setting\n         * @param {string} key               The key\n         * @param {string=null} defaultValue The default value\n         * @returns {string}                 The setting value\n         */\n        static getSetting (key, defaultValue = null) {\n            let value = defaultValue ?? null\n            try {\n                value = game.settings.get(MODULE.ID, key)\n            } catch {\n                coreModule.api.Logger.debug(`Setting '${key}' not found`)\n            }\n            return value\n        }\n\n        /**\n         * Set setting\n         * @param {string} key   The key\n         * @param {string} value The value\n         */\n        static async setSetting (key, value) {\n            try {\n                value = await game.settings.set(MODULE.ID, key, value)\n                coreModule.api.Logger.debug(`Setting '${key}' set to '${value}'`)\n            } catch {\n                coreModule.api.Logger.debug(`Setting '${key}' not found`)\n            }\n        }\n    }\n})\n","// System Module Imports\nimport { ACTION_TYPE, ITEM_TYPE } from './constants.js'\nimport { Utils } from './utils.js'\n\nexport let ActionHandler = null\n\nHooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\n    /**\n     * Extends Token Action HUD Core's ActionHandler class and builds system-defined actions for the HUD\n     */\n    ActionHandler = class ActionHandler extends coreModule.api.ActionHandler {\n        /**\n         * Build system actions\n         * Called by Token Action HUD Core\n         * @override\n         * @param {array} groupIds\n         */a\n        async buildSystemActions (groupIds) {\n            // Set actor and token variables\n            this.actors = (!this.actor) ? this._getActors() : [this.actor]\n            this.actorType = this.actor?.type\n\n            // Settings\n            this.displayUnequipped = Utils.getSetting('displayUnequipped')\n\n            // Set items variable\n            if (this.actor) {\n                let items = this.actor.items\n                items = coreModule.api.Utils.sortItemsByName(items)\n                this.items = items\n            }\n\n            if (this.actorType === 'character') {\n                this.#buildCharacterActions()\n            } else if (!this.actor) {\n                this.#buildMultipleTokenActions()\n            }\n        }\n\n        /**\n         * Build character actions\n         * @private\n         */\n        #buildCharacterActions () {\n            this.#buildInventory()\n        }\n\n        /**\n         * Build multiple token actions\n         * @private\n         * @returns {object}\n         */\n        #buildMultipleTokenActions () {\n        }\n\n        /**\n         * Build inventory\n         * @private\n         */\n        async #buildInventory () {\n            if (this.items.size === 0) return\n\n            const actionTypeId = 'item'\n            const inventoryMap = new Map()\n\n            for (const [itemId, itemData] of this.items) {\n                const type = itemData.type\n                const equipped = itemData.equipped\n\n                if (equipped || this.displayUnequipped) {\n                    const typeMap = inventoryMap.get(type) ?? new Map()\n                    typeMap.set(itemId, itemData)\n                    inventoryMap.set(type, typeMap)\n                }\n            }\n\n            for (const [type, typeMap] of inventoryMap) {\n                const groupId = ITEM_TYPE[type]?.groupId\n\n                if (!groupId) continue\n\n                const groupData = { id: groupId, type: 'system' }\n\n                // Get actions\n                const actions = [...typeMap].map(([itemId, itemData]) => {\n                    const id = itemId\n                    const name = itemData.name\n                    const actionTypeName = coreModule.api.Utils.i18n(ACTION_TYPE[actionTypeId])\n                    const listName = `${actionTypeName ? `${actionTypeName}: ` : ''}${name}`\n                    const encodedValue = [actionTypeId, id].join(this.delimiter)\n\n                    return {\n                        id,\n                        name,\n                        listName,\n                        encodedValue\n                    }\n                })\n\n                // TAH Core method to add actions to the action list\n                this.addActions(actions, groupData)\n            }\n        }\n    }\n})\n","import { GROUP } from './constants.js'\n\n/**\n * Default layout and groups\n */\nexport let DEFAULTS = null\n\nHooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\n    const groups = GROUP\n    Object.values(groups).forEach(group => {\n        group.name = coreModule.api.Utils.i18n(group.name)\n        group.listName = `Group: ${coreModule.api.Utils.i18n(group.listName ?? group.name)}`\n    })\n    const groupsArray = Object.values(groups)\n    DEFAULTS = {\n        layout: [\n            {\n                nestId: 'moves',\n                id: 'moves',\n                name: coreModule.api.Utils.i18n('tokenActionHud.ironsworn.moves'),\n                groups: [\n                    { ...groups.moves, nestId: 'moves' },\n                ]\n            }\n        ],\n        groups: groupsArray\n    }\n})\n","export let RollHandler = null\n\nHooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\n    /**\n     * Extends Token Action HUD Core's RollHandler class and handles action events triggered when an action is clicked\n     */\n    RollHandler = class RollHandler extends coreModule.api.RollHandler {\n        /**\n         * Handle action click\n         * Called by Token Action HUD Core when an action is left or right-clicked\n         * @override\n         * @param {object} event        The event\n         * @param {string} encodedValue The encoded value\n         */\n        async handleActionClick (event, encodedValue) {\n            const [actionTypeId, actionId] = encodedValue.split('|')\n\n            const renderable = ['item']\n\n            if (renderable.includes(actionTypeId) && this.isRenderItem()) {\n                return this.doRenderItem(this.actor, actionId)\n            }\n\n            const knownCharacters = ['character']\n\n            // If single actor is selected\n            if (this.actor) {\n                await this.#handleAction(event, this.actor, this.token, actionTypeId, actionId)\n                return\n            }\n\n            const controlledTokens = canvas.tokens.controlled\n                .filter((token) => knownCharacters.includes(token.actor?.type))\n\n            // If multiple actors are selected\n            for (const token of controlledTokens) {\n                const actor = token.actor\n                await this.#handleAction(event, actor, token, actionTypeId, actionId)\n            }\n        }\n\n        /**\n         * Handle action hover\n         * Called by Token Action HUD Core when an action is hovered on or off\n         * @override\n         * @param {object} event        The event\n         * @param {string} encodedValue The encoded value\n         */\n        async handleActionHover (event, encodedValue) {}\n\n        /**\n         * Handle group click\n         * Called by Token Action HUD Core when a group is right-clicked while the HUD is locked\n         * @override\n         * @param {object} event The event\n         * @param {object} group The group\n         */\n        async handleGroupClick (event, group) {}\n\n        /**\n         * Handle action\n         * @private\n         * @param {object} event        The event\n         * @param {object} actor        The actor\n         * @param {object} token        The token\n         * @param {string} actionTypeId The action type id\n         * @param {string} actionId     The actionId\n         */\n        async #handleAction (event, actor, token, actionTypeId, actionId) {\n            switch (actionTypeId) {\n            case 'item':\n                this.#handleItemAction(event, actor, actionId)\n                break\n            case 'utility':\n                this.#handleUtilityAction(token, actionId)\n                break\n            }\n        }\n\n        /**\n         * Handle item action\n         * @private\n         * @param {object} event    The event\n         * @param {object} actor    The actor\n         * @param {string} actionId The action id\n         */\n        #handleItemAction (event, actor, actionId) {\n            const item = actor.items.get(actionId)\n            item.toChat(event)\n        }\n\n        /**\n         * Handle utility action\n         * @private\n         * @param {object} token    The token\n         * @param {string} actionId The action id\n         */\n        async #handleUtilityAction (token, actionId) {\n            switch (actionId) {\n            case 'endTurn':\n                if (game.combat?.current?.tokenId === token.id) {\n                    await game.combat?.nextTurn()\n                }\n                break\n            }\n        }\n    }\n})\n","import { MODULE } from './constants.js'\n\n/**\n * Register module settings\n * Called by Token Action HUD Core to register Token Action HUD system module settings\n * @param {function} coreUpdate Token Action HUD Core update function\n */\nexport function register (coreUpdate) {\n    // game.settings.register(MODULE.ID, 'displayUnequipped', {\n    //     name: game.i18n.localize('tokenActionHud.ironsworn.settings.displayUnequipped.name'),\n    //     hint: game.i18n.localize('tokenActionHud.ironsworn.settings.displayUnequipped.hint'\n    //     ),\n    //     scope: 'client',\n    //     config: true,\n    //     type: Boolean,\n    //     default: true,\n    //     onChange: (value) => {\n    //         coreUpdate(value)\n    //     }\n    // })\n}\n","// System Module Imports\nimport { ActionHandler } from './action-handler.js'\nimport { RollHandler as Core } from './roll-handler.js'\nimport { MODULE } from './constants.js'\nimport { DEFAULTS } from './defaults.js'\nimport * as systemSettings from './settings.js'\n\nexport let SystemManager = null\n\nHooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\n    /**\n     * Extends Token Action HUD Core's SystemManager class\n     */\n    SystemManager = class SystemManager extends coreModule.api.SystemManager {\n        /**\n         * Returns an instance of the ActionHandler to Token Action HUD Core\n         * Called by Token Action HUD Core\n         * @override\n         * @returns {class} The ActionHandler instance\n         */\n        getActionHandler () {\n            return new ActionHandler()\n        }\n\n        /**\n         * Returns a list of roll handlers to Token Action HUD Core\n         * Used to populate the Roll Handler module setting choices\n         * Called by Token Action HUD Core\n         * @override\n         * @returns {object} The available roll handlers\n         */\n        getAvailableRollHandlers () {\n            const coreTitle = 'Core Ironsworn'\n            const choices = { core: coreTitle }\n            return choices\n        }\n\n        /**\n         * Returns an instance of the RollHandler to Token Action HUD Core\n         * Called by Token Action HUD Core\n         * @override\n         * @param {string} rollHandlerId The roll handler ID\n         * @returns {class}              The RollHandler instance\n         */\n        getRollHandler (rollHandlerId) {\n            let rollHandler\n            switch (rollHandlerId) {\n            case 'core':\n            default:\n                rollHandler = new Core()\n                break\n            }\n            return rollHandler\n        }\n\n        /**\n         * Returns the default layout and groups to Token Action HUD Core\n         * Called by Token Action HUD Core\n         * @returns {object} The default layout and groups\n         */\n        async registerDefaults () {\n            return DEFAULTS\n        }\n\n        /**\n         * Register Token Action HUD system module settings\n         * Called by Token Action HUD Core\n         * @override\n         * @param {function} coreUpdate The Token Action HUD Core update function\n         */\n        registerSettings (coreUpdate) {\n            systemSettings.register(coreUpdate)\n        }\n\n        /**\n         * Returns styles to Token Action HUD Core\n         * Called by Token Action HUD Core\n         * @override\n         * @returns {object} The TAH system styles\n         */\n        registerStyles () {\n            return {\n                template: {\n                    class: 'tah-style-template-style', // The class to add to first DIV element\n                    file: 'tah-template-style', // The file without the css extension\n                    moduleId: MODULE.ID, // The module ID\n                    name: 'Template Style' // The name to display in the Token Action HUD Core 'Style' module setting\n                }\n            }\n        }\n    }\n})\n","import { SystemManager } from './system-manager.js'\nimport { MODULE, REQUIRED_CORE_MODULE_VERSION } from './constants.js'\n\nHooks.on('tokenActionHudCoreApiReady', async () => {\n    /**\n     * Return the SystemManager and requiredCoreModuleVersion to Token Action HUD Core\n     */\n    const module = game.modules.get(MODULE.ID)\n    module.api = {\n        requiredCoreModuleVersion: REQUIRED_CORE_MODULE_VERSION,\n        SystemManager\n    }\n    Hooks.call('tokenActionHudSystemReady', module)\n})\n"],"names":["MODULE","ID","CORE_MODULE","REQUIRED_CORE_MODULE_VERSION","ACTION_TYPE","move","GROUP","moves","id","name","type","ITEM_TYPE","armor","groupId","backpack","consumable","equipment","treasure","weapon","Utils","Hooks","once","async","coreModule","static","key","defaultValue","value","game","settings","get","api","Logger","debug","set","ActionHandler","a","groupIds","this","actors","actor","_getActors","actorType","displayUnequipped","getSetting","items","sortItemsByName","buildCharacterActions","buildMultipleTokenActions","buildInventory","size","actionTypeId","inventoryMap","Map","itemId","itemData","equipped","typeMap","groupData","actions","map","actionTypeName","i18n","listName","encodedValue","join","delimiter","addActions","DEFAULTS","groups","Object","values","forEach","group","groupsArray","layout","nestId","RollHandler","register","coreUpdate","event","actionId","split","includes","isRenderItem","doRenderItem","knownCharacters","handleAction","token","controlledTokens","canvas","tokens","controlled","filter","handleItemAction","handleUtilityAction","toChat","combat","current","tokenId","nextTurn","SystemManager","getActionHandler","getAvailableRollHandlers","core","getRollHandler","rollHandlerId","rollHandler","Core","registerSettings","registerStyles","template","class","file","moduleId","on","module","modules","requiredCoreModuleVersion","call"],"mappings":"AAGY,MAACA,EAAS,CAClBC,GAAI,8BAMKC,EAAc,CACvBD,GAAI,yBAMKE,EAA+B,MAK/BC,EAAc,CACvBC,KAAM,kCAMGC,EAAQ,CACjBC,MAAO,CAAEC,GAAI,QAASC,KAAM,iCAAkCC,KAAM,WAM3DC,EAAY,CACrBC,MAAO,CAAEC,QAAS,SAClBC,SAAU,CAAED,QAAS,cACrBE,WAAY,CAAEF,QAAS,eACvBG,UAAW,CAAEH,QAAS,aACtBI,SAAU,CAAEJ,QAAS,YACrBK,OAAQ,CAAEL,QAAS,YCxCb,IAACM,EAAQ,KAEnBC,MAAMC,KAAK,8BAA8BC,MAAOC,IAI5CJ,EAAQ,MAAMA,MAOVK,kBAAmBC,EAAKC,EAAe,MACnC,IAAIC,EAAQD,GAAgB,KAC5B,IACIC,EAAQC,KAAKC,SAASC,IAAI9B,EAAOC,GAAIwB,EAGxC,CAFC,MACEF,EAAWQ,IAAIC,OAAOC,MAAM,YAAYR,eAC3C,CACD,OAAOE,CACV,CAODH,wBAAyBC,EAAKE,GAC1B,IACIA,QAAcC,KAAKC,SAASK,IAAIlC,EAAOC,GAAIwB,EAAKE,GAChDJ,EAAWQ,IAAIC,OAAOC,MAAM,YAAYR,cAAgBE,KAG3D,CAFC,MACEJ,EAAWQ,IAAIC,OAAOC,MAAM,YAAYR,eAC3C,CACJ,EACJ,IClCK,IAACU,EAAgB,KAE3Bf,MAAMC,KAAK,8BAA8BC,MAAOC,IAI5CY,EAAgB,MAAMA,sBAAsBZ,EAAWQ,IAAII,cAMpDC,EACHd,yBAA0Be,GAStB,GAPAC,KAAKC,OAAWD,KAAKE,MAA6B,CAACF,KAAKE,OAA1BF,KAAKG,aACnCH,KAAKI,UAAYJ,KAAKE,OAAO9B,KAG7B4B,KAAKK,kBAAoBxB,EAAMyB,WAAW,qBAGtCN,KAAKE,MAAO,CACZ,IAAIK,EAAQP,KAAKE,MAAMK,MACvBA,EAAQtB,EAAWQ,IAAIZ,MAAM2B,gBAAgBD,GAC7CP,KAAKO,MAAQA,CAChB,CAEsB,cAAnBP,KAAKI,UACLJ,MAAKS,IACGT,KAAKE,OACbF,MAAKU,GAEZ,CAMDD,KACIT,MAAKW,GACR,CAODD,KACC,CAMD1B,UACI,GAAwB,IAApBgB,KAAKO,MAAMK,KAAY,OAE3B,MAAMC,EAAe,OACfC,EAAe,IAAIC,IAEzB,IAAK,MAAOC,EAAQC,KAAajB,KAAKO,MAAO,CACzC,MAAMnC,EAAO6C,EAAS7C,KAGtB,GAFiB6C,EAASC,UAEVlB,KAAKK,kBAAmB,CACpC,MAAMc,EAAUL,EAAatB,IAAIpB,IAAS,IAAI2C,IAC9CI,EAAQvB,IAAIoB,EAAQC,GACpBH,EAAalB,IAAIxB,EAAM+C,EAC1B,CACJ,CAED,IAAK,MAAO/C,EAAM+C,KAAYL,EAAc,CACxC,MAAMvC,EAAUF,EAAUD,IAAOG,QAEjC,IAAKA,EAAS,SAEd,MAAM6C,EAAY,CAAElD,GAAIK,EAASH,KAAM,UAGjCiD,EAAU,IAAIF,GAASG,KAAI,EAAEN,EAAQC,MACvC,MAAM/C,EAAK8C,EACL7C,EAAO8C,EAAS9C,KAChBoD,EAAiBtC,EAAWQ,IAAIZ,MAAM2C,KAAK1D,EAAY+C,IACvDY,EAAW,GAAGF,EAAiB,GAAGA,MAAqB,KAAKpD,IAC5DuD,EAAe,CAACb,EAAc3C,GAAIyD,KAAK3B,KAAK4B,WAElD,MAAO,CACH1D,KACAC,OACAsD,WACAC,eACH,IAIL1B,KAAK6B,WAAWR,EAASD,EAC5B,CACJ,EACJ,IClGK,IAACU,EAAW,KAEtBhD,MAAMC,KAAK,8BAA8BC,MAAOC,IAC5C,MAAM8C,EAAS/D,EACfgE,OAAOC,OAAOF,GAAQG,SAAQC,IAC1BA,EAAMhE,KAAOc,EAAWQ,IAAIZ,MAAM2C,KAAKW,EAAMhE,MAC7CgE,EAAMV,SAAW,UAAUxC,EAAWQ,IAAIZ,MAAM2C,KAAKW,EAAMV,UAAYU,EAAMhE,OAAO,IAExF,MAAMiE,EAAcJ,OAAOC,OAAOF,GAClCD,EAAW,CACPO,OAAQ,CACJ,CACIC,OAAQ,QACRpE,GAAI,QACJC,KAAMc,EAAWQ,IAAIZ,MAAM2C,KAAK,kCAChCO,OAAQ,CACJ,IAAKA,EAAO9D,MAAOqE,OAAQ,YAIvCP,OAAQK,EACX,IC1BK,IAACG,EAAc,KCOlB,SAASC,SAAUC,GAa1B,CDlBA3D,MAAMC,KAAK,8BAA8BC,MAAOC,IAI5CsD,EAAc,MAAMA,oBAAoBtD,EAAWQ,IAAI8C,YAQnDvD,wBAAyB0D,EAAOhB,GAC5B,MAAOb,EAAc8B,GAAYjB,EAAakB,MAAM,KAIpD,GAFmB,CAAC,QAELC,SAAShC,IAAiBb,KAAK8C,eAC1C,OAAO9C,KAAK+C,aAAa/C,KAAKE,MAAOyC,GAGzC,MAAMK,EAAkB,CAAC,aAGzB,GAAIhD,KAAKE,MAEL,kBADMF,MAAKiD,EAAcP,EAAO1C,KAAKE,MAAOF,KAAKkD,MAAOrC,EAAc8B,GAI1E,MAAMQ,EAAmBC,OAAOC,OAAOC,WAClCC,QAAQL,GAAUF,EAAgBH,SAASK,EAAMhD,OAAO9B,QAG7D,IAAK,MAAM8E,KAASC,EAAkB,CAClC,MAAMjD,EAAQgD,EAAMhD,YACdF,MAAKiD,EAAcP,EAAOxC,EAAOgD,EAAOrC,EAAc8B,EAC/D,CACJ,CASD3D,wBAAyB0D,EAAOhB,GAAgB,CAShD1C,uBAAwB0D,EAAOP,GAAS,CAWxCnD,QAAqB0D,EAAOxC,EAAOgD,EAAOrC,EAAc8B,GACpD,OAAQ9B,GACR,IAAK,OACDb,MAAKwD,EAAkBd,EAAOxC,EAAOyC,GACrC,MACJ,IAAK,UACD3C,MAAKyD,EAAqBP,EAAOP,GAGxC,CASDa,GAAmBd,EAAOxC,EAAOyC,GAChBzC,EAAMK,MAAMf,IAAImD,GACxBe,OAAOhB,EACf,CAQD1D,QAA4BkE,EAAOP,GAC/B,GACK,YADGA,EAEArD,KAAKqE,QAAQC,SAASC,UAAYX,EAAMhF,UAClCoB,KAAKqE,QAAQG,WAI9B,EACJ,IEnGK,IAACC,EAAgB,KAE3BjF,MAAMC,KAAK,8BAA8BC,MAAOC,IAI5C8E,EAAgB,MAAMA,sBAAsB9E,EAAWQ,IAAIsE,cAOvDC,mBACI,OAAO,IAAInE,CACd,CASDoE,2BAGI,MADgB,CAAEC,KADA,iBAGrB,CASDC,eAAgBC,GACZ,IAAIC,EAOJ,OAHIA,EAAc,IAAIC,EAGfD,CACV,CAODrF,yBACI,OAAO8C,CACV,CAQDyC,iBAAkB9B,GAEjB,CAQD+B,iBACI,MAAO,CACHC,SAAU,CACNC,MAAO,2BACPC,KAAM,qBACNC,SAAUlH,EAAOC,GACjBQ,KAAM,kBAGjB,EACJ,ICvFLW,MAAM+F,GAAG,8BAA8B7F,UAInC,MAAM8F,EAASxF,KAAKyF,QAAQvF,IAAI9B,EAAOC,IACvCmH,EAAOrF,IAAM,CACTuF,0BPQoC,MOPpCjB,iBAEJjF,MAAMmG,KAAK,4BAA6BH,EAAO"}